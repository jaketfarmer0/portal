// prisma/schema.prisma

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//////////////////////////////////////////////////////
// ENUMS
//////////////////////////////////////////////////////

enum UserRole {
  RESELLER
  CLIENT
  ADMIN
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

//////////////////////////////////////////////////////
// MODELS
//////////////////////////////////////////////////////

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String?
  role     UserRole @default(CLIENT)

  resellerProfile ResellerProfile?
  clientPortals   ClientPortal[]   @relation("ResellerClientPortals")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ResellerProfile {
  id                   String             @id @default(cuid())
  userId               String             @unique
  user                 User               @relation(fields: [userId], references: [id])
  subscriptionStatus   SubscriptionStatus @default(TRIALING)
  trialEndsAt          DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  brandColor           String?
  logoUrl              String?
  faviconUrl           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ClientPortal {
  id         String @id @default(cuid())
  slug       String @unique
  name       String
  resellerId String
  reseller   User   @relation("ResellerClientPortals", fields: [resellerId], references: [id])

  accentColor  String?
  primaryColor String?
  logoUrl      String?

  services  Service[]
  bookings  Booking[]
  customers Customer[]
  invites   InviteToken[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Staff        Staff[]
  Availability Availability[]

  @@index([resellerId])
  @@index([slug])
}

model Service {
  id             String       @id @default(cuid())
  clientPortalId String
  clientPortal   ClientPortal @relation(fields: [clientPortalId], references: [id])

  name         String
  description  String?
  priceCents   Int
  durationMins Int?

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientPortalId])
}

model Customer {
  id             String       @id @default(cuid())
  clientPortalId String
  clientPortal   ClientPortal @relation(fields: [clientPortalId], references: [id])

  name  String
  email String

  bookings Booking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientPortalId])
  @@index([email, clientPortalId])
}

model Staff {
  id             String       @id @default(cuid())
  clientPortal   ClientPortal @relation(fields: [clientPortalId], references: [id])
  clientPortalId String

  name  String
  email String?
  role  String?

  availabilities Availability[]
  bookings       Booking[]
}

model Availability {
  id             String       @id @default(cuid())
  clientPortal   ClientPortal @relation(fields: [clientPortalId], references: [id])
  clientPortalId String

  staff   Staff?  @relation(fields: [staffId], references: [id])
  staffId String?

  dayOfWeek Int
  startTime String
  endTime   String
}

model Booking {
  id             String       @id @default(cuid())
  clientPortal   ClientPortal @relation(fields: [clientPortalId], references: [id])
  clientPortalId String

  service   Service @relation(fields: [serviceId], references: [id])
  serviceId String

  customer   Customer? @relation(fields: [customerId], references: [id])
  customerId String?

  staff   Staff?  @relation(fields: [staffId], references: [id])
  staffId String?

  startTime DateTime
  endTime   DateTime
  status    BookingStatus @default(PENDING)
  notes     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientPortalId, startTime])
  @@index([customerId])
}

model InviteToken {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  expiresAt      DateTime
  clientPortal   ClientPortal @relation(fields: [clientPortalId], references: [id])
  clientPortalId String
  createdAt      DateTime     @default(now())
}

model EmailLog {
  id        String   @id @default(cuid())
  toEmail   String
  template  String
  meta      Json?
  createdAt DateTime @default(now())
}
